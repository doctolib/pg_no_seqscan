# Contributing

Here are some hints to prepare your environment to contribute to the project:

- Install git (pre-commit)[https://pre-commit.com/] hooks with `pre-commit install`
- Start a PG with the extension `cargo pgrx run`
- Run tests with `cargo pgrx regress` (use options --resetdb to force the reset of the db, and --auto to automatically update the expected results)
- Format with `cargo fmt`
- Lint with `cargo clippy`

Pg_no_seqscan must be initialized in the extension's _PG_init() function, and can only be started if loaded through the
shared_preload_libraries configuration setting.

In order that all future workers answering queries use this extension, you'll need to edit the proper postgresql.conf file
in "${PGRX_HOME}/data-$PGVER/postgresql.conf" and add this at the end of the file:

    shared_preload_libraries = 'pg_no_seqscan.so'
    jit_above_cost = 40000000000
    enable_seqscan = 'off'
    # Recommended to have logs with `tail -f ~/.pgrx/data-15/log/postgresql.log`
    logging_collector = on
    log_filename = 'postgresql.log'

## Regression tests

We rely on [pg_regress](https://github.com/pgcentralfoundation/pgrx/blob/develop/cargo-pgrx/README.md#testing-with-regression-tests)
to run tests.

Have in mind that we rely on pg_regress [variants](https://www.postgresql.org/docs/current/regress-variant.html) to define multiple outputs for the same test, depending on the PostgreSQL version.

Concretely on the following approach allowed by pg_regress:

> The second selection mechanism for variant comparison files is much more automatic: 
> it simply uses the "best match" among several supplied comparison files. The regression
> test driver script considers both the standard comparison file for a test, testname.out,
> and variant files named testname_digit.out (where the digit is any single digit 0-9).
> If any such file is an exact match, the test is considered to pass; otherwise, the one
> that generates the shortest diff is used to create the failure report. 

### Generate expected from docker

To run expected from docker and avoid the installation of postgres locally:

- start the docker: `docker run --rm -it -v "$(pwd):/workspace" -w /workspace pgxn/pgxn-tools bash`
- install pg: `pg-start 18` replace 18 with or the version of your choice
- install cargo and pgrx, build the extension, launch tests: `pgrx-build-test`
- just run test again: `make installcheck PGUSER=postgres`

## Update the documentation

Make sure the documentation remains up to date and add your changes in the `CHANGELOG.md` file,
in a heading `## [Unreleased]` section.
