-- Test that EXPLAIN (COSTS OFF) queries are ignored
SELECT 'Before PG 18?', setting::int / 10000 < 18 from pg_settings where name = 'server_version_num' ; -- output changed slightly from PG18
   ?column?    | ?column? 
---------------+----------
 Before PG 18? | t
(1 row)

-- Setup
LOAD 'pg_no_seqscan';
SET pg_no_seqscan.level = ERROR;
CREATE TABLE test_explain AS (SELECT * FROM generate_series(1,10) AS id);
-- Allows query execution as it is an EXPLAIN, and no seqscan will occur
EXPLAIN (COSTS OFF)
SELECT * FROM test_explain;
        QUERY PLAN        
--------------------------
 Seq Scan on test_explain
(1 row)

-- Allows query execution as it is an EXPLAIN ANALYZE, as it may be useful to understand the plan
EXPLAIN (ANALYZE, COSTS OFF, TIMING OFF, SUMMARY OFF, BUFFERS OFF) SELECT * FROM test_explain;
                    QUERY PLAN                     
---------------------------------------------------
 Seq Scan on test_explain (actual rows=10 loops=1)
(1 row)

-- Allows query execution as it is an EXPLAIN ANALYZE, even for parallel queries
SET parallel_setup_cost = 0;
SET parallel_tuple_cost = 0.000001;
CREATE TABLE test_explain_parallel (id, migrated_at) AS (SELECT generate_series(1, 800000)::bigint id, null::text);
EXPLAIN (ANALYZE, COSTS OFF, TIMING OFF, SUMMARY OFF, BUFFERS OFF) select count(*) from test_explain_parallel;
                                        QUERY PLAN                                         
-------------------------------------------------------------------------------------------
 Finalize Aggregate (actual rows=1 loops=1)
   ->  Gather (actual rows=3 loops=1)
         Workers Planned: 2
         Workers Launched: 2
         ->  Partial Aggregate (actual rows=1 loops=3)
               ->  Parallel Seq Scan on test_explain_parallel (actual rows=266667 loops=3)
(6 rows)

SET parallel_setup_cost TO DEFAULT;
SET parallel_tuple_cost TO DEFAULT;
-- Blocks query execution as this is the real query
SELECT * FROM test_explain;
ERROR:  A 'Sequential Scan' has been detected. Make sure the query is compatible with the existing indexes.
  - Tables involved: test_explain
  - Query: SELECT * FROM test_explain;
  - Query plan:

  Seq Scan on test_explain


-- cleanup
drop table test_explain;
drop table test_explain_parallel;
