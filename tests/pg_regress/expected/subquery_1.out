-- Test subquery detection
select Substr(setting, 1, 2) = '18' from pg_settings where name = 'server_version_num'; -- output changed slightly from PG18
 ?column? 
----------
 t
(1 row)

-- Setup
LOAD 'pg_no_seqscan';
SET pg_no_seqscan.level = ERROR;
SET enable_seqscan = off;
CREATE TABLE test_subq AS (SELECT * FROM generate_series(1,10) as id);
CREATE INDEX test_subq_idx ON test_subq(id) where id = 2;
-- Blocks query execution as a seqscan occur in first branch
EXPLAIN (COSTS OFF)
SELECT * FROM test_subq where id = 2
EXCEPT
SELECT * FROM test_subq;
                       QUERY PLAN                       
--------------------------------------------------------
 HashSetOp Except
   ->  Index Only Scan using test_subq_idx on test_subq
   ->  Seq Scan on test_subq test_subq_1
         Disabled: true
(4 rows)

SELECT * FROM test_subq where id = 2
EXCEPT
SELECT * FROM test_subq;
ERROR:  A 'Sequential Scan' has been detected. Make sure the query is compatible with the existing indexes.
  - Tables involved: test_subq
  - Query: SELECT * FROM test_subq where id = 2
EXCEPT
SELECT * FROM test_subq;
  - Query plan:

  HashSetOp Except
  ->  Index Only Scan using test_subq_idx on test_subq
  ->  Seq Scan on test_subq test_subq_1
        Disabled: true


-- Blocks query execution as a seqscan occur in second branch
EXPLAIN (COSTS OFF)
SELECT * FROM test_subq
EXCEPT
SELECT * FROM test_subq where id = 2;
                             QUERY PLAN                             
--------------------------------------------------------------------
 HashSetOp Except
   ->  Seq Scan on test_subq
         Disabled: true
   ->  Index Only Scan using test_subq_idx on test_subq test_subq_1
(4 rows)

SELECT * FROM test_subq
EXCEPT
SELECT * FROM test_subq where id = 2;
ERROR:  A 'Sequential Scan' has been detected. Make sure the query is compatible with the existing indexes.
  - Tables involved: test_subq
  - Query: SELECT * FROM test_subq
EXCEPT
SELECT * FROM test_subq where id = 2;
  - Query plan:

  HashSetOp Except
  ->  Seq Scan on test_subq
        Disabled: true
  ->  Index Only Scan using test_subq_idx on test_subq test_subq_1


-- Cleanup
DROP TABLE test_subq;
