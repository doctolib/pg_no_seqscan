-- Test partitioning support
LOAD 'pg_no_seqscan';
SET pg_no_seqscan.level = ERROR;
SET enable_seqscan = off;
CREATE TABLE partitioned_foo (id bigint) PARTITION BY RANGE (id);
CREATE TABLE partitioned_foo_1 PARTITION OF partitioned_foo FOR VALUES FROM (1) TO (5);
CREATE TABLE partitioned_foo_2 PARTITION OF partitioned_foo FOR VALUES FROM (5) TO (11) PARTITION BY RANGE (id);
CREATE TABLE partitioned_foo_2_1 PARTITION OF partitioned_foo_2 FOR VALUES FROM (5) TO (8);
CREATE TABLE partitioned_foo_2_2 PARTITION OF partitioned_foo_2 FOR VALUES FROM (8) TO (11);
INSERT INTO partitioned_foo SELECT i FROM generate_series(1, 10) i;
select id, tableoid::regclass from partitioned_foo order by id /*pg_no_seqscan_skip*/;
 id |      tableoid       
----+---------------------
  1 | partitioned_foo_1
  2 | partitioned_foo_1
  3 | partitioned_foo_1
  4 | partitioned_foo_1
  5 | partitioned_foo_2_1
  6 | partitioned_foo_2_1
  7 | partitioned_foo_2_1
  8 | partitioned_foo_2_2
  9 | partitioned_foo_2_2
 10 | partitioned_foo_2_2
(10 rows)

create index on partitioned_foo_1 USING btree (id);
explain (costs off) select id, tableoid::regclass from partitioned_foo order by id;
                                 QUERY PLAN                                 
----------------------------------------------------------------------------
 Sort
   Sort Key: partitioned_foo.id
   ->  Append
         ->  Index Scan using partitioned_foo_1_id_idx on partitioned_foo_1
         ->  Seq Scan on partitioned_foo_2_1 partitioned_foo_2
         ->  Seq Scan on partitioned_foo_2_2 partitioned_foo_3
(6 rows)

-- when no rules are defined, the seq scan should be blocked
select id, tableoid::regclass from partitioned_foo order by id;
ERROR:  A 'Sequential Scan' on partitioned_foo has been detected.
  - Run an EXPLAIN on your query to check the query plan.
  - Make sure the query is compatible with the existing indexes.

Query: select id, tableoid::regclass from partitioned_foo order by id;

-- when only the root table is checked, seq scan should be blocked
SET pg_no_seqscan.check_tables = 'partitioned_foo';
select id, tableoid::regclass from partitioned_foo order by id;
ERROR:  A 'Sequential Scan' on partitioned_foo has been detected.
  - Run an EXPLAIN on your query to check the query plan.
  - Make sure the query is compatible with the existing indexes.

Query: select id, tableoid::regclass from partitioned_foo order by id;

DROP TABLE partitioned_foo cascade;
