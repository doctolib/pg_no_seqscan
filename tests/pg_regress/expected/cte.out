-- Test detection in CTE
-- Setup
LOAD 'pg_no_seqscan';
SET pg_no_seqscan.level = ERROR;
CREATE TABLE test_cte AS (SELECT * FROM generate_series(1,10) as id);
-- Show plan
EXPLAIN (COSTS OFF)
WITH cte AS MATERIALIZED (SELECT * FROM test_cte LIMIT 10) SELECT * FROM cte ORDER BY id;
             QUERY PLAN             
------------------------------------
 Sort
   Sort Key: cte.id
   CTE cte
     ->  Limit
           ->  Seq Scan on test_cte
   ->  CTE Scan on cte
(6 rows)

-- Expect to fail
WITH cte AS MATERIALIZED (SELECT * FROM test_cte LIMIT 10) SELECT * FROM cte;
ERROR:  A 'Sequential Scan' on test_cte has been detected.
  - Run an EXPLAIN on your query to check the query plan.
  - Make sure the query is compatible with the existing indexes.

Query: WITH cte AS MATERIALIZED (SELECT * FROM test_cte LIMIT 10) SELECT * FROM cte;

-- Cleanup
DROP TABLE test_cte;
