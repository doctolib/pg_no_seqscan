-- Test detection in APPEND
LOAD 'pg_no_seqscan';
SET pg_no_seqscan.level = ERROR;
SET enable_seqscan = off;
CREATE TABLE test_for_append (id int, data text);
INSERT INTO test_for_append SELECT i, 'data' || i FROM generate_series(1, 5) i;
EXPLAIN (COSTS OFF) (SELECT * FROM test_for_append ORDER BY id LIMIT 1) UNION ALL (SELECT * FROM test_for_append ORDER BY id desc LIMIT 1);
                           QUERY PLAN                            
-----------------------------------------------------------------
 Append
   ->  Limit
         ->  Sort
               Sort Key: test_for_append.id
               ->  Seq Scan on test_for_append
                     Disabled: true
   ->  Limit
         ->  Sort
               Sort Key: test_for_append_1.id DESC
               ->  Seq Scan on test_for_append test_for_append_1
                     Disabled: true
(11 rows)

(SELECT * FROM test_for_append ORDER BY id LIMIT 1) UNION ALL (SELECT * FROM test_for_append ORDER BY id desc LIMIT 1);
ERROR:  A 'Sequential Scan' on test_for_append,test_for_append has been detected.
  - Run an EXPLAIN on your query to check the query plan.
  - Make sure the query is compatible with the existing indexes.

Query: (SELECT * FROM test_for_append ORDER BY id LIMIT 1) UNION ALL (SELECT * FROM test_for_append ORDER BY id desc LIMIT 1);

-- Blocks seq scan even if the first part of the append is an index scan.
CREATE INDEX test_for_append_idx ON test_for_append (id);
EXPLAIN (COSTS OFF) (SELECT * FROM test_for_append ORDER BY id LIMIT 1) UNION ALL (SELECT * FROM test_for_append ORDER BY random() LIMIT 1);
                              QUERY PLAN                               
-----------------------------------------------------------------------
 Append
   ->  Limit
         ->  Index Scan using test_for_append_idx on test_for_append
   ->  Subquery Scan on "*SELECT* 2"
         ->  Limit
               ->  Sort
                     Sort Key: (random())
                     ->  Seq Scan on test_for_append test_for_append_1
                           Disabled: true
(9 rows)

(SELECT * FROM test_for_append ORDER BY id LIMIT 1) UNION ALL (SELECT * FROM test_for_append ORDER BY random() LIMIT 1);
ERROR:  A 'Sequential Scan' on test_for_append has been detected.
  - Run an EXPLAIN on your query to check the query plan.
  - Make sure the query is compatible with the existing indexes.

Query: (SELECT * FROM test_for_append ORDER BY id LIMIT 1) UNION ALL (SELECT * FROM test_for_append ORDER BY random() LIMIT 1);

DROP TABLE test_for_append;
