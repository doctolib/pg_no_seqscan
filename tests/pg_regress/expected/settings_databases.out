-- Test database filtering
-- Setup
LOAD 'pg_no_seqscan';
SET pg_no_seqscan.level = ERROR;
CREATE TABLE test_db AS (SELECT * FROM generate_series(1,10) as id);
-- Blocks query execution as check_databases is empty thus all databases are checked
SET pg_no_seqscan.check_databases = '';
EXPLAIN (COSTS OFF) SELECT * FROM test_db;
     QUERY PLAN      
---------------------
 Seq Scan on test_db
(1 row)

SELECT * FROM test_db; -- Should error
ERROR:  A 'Sequential Scan' has been detected:

  - Tables involved:

  test_db

  - Query:

  SELECT * FROM test_db;

  - Query plan:

  Seq Scan on test_db


Make sure the query is compatible with the existing indexes.

-- Allows query execution as check_databases is not set to the current database
SET pg_no_seqscan.check_databases = 'postgres';
SELECT * FROM test_db; -- Should pass
 id 
----
  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
(10 rows)

-- Current database depends on the test runner (ex: contrib_regression) that's why we use this hack to not return the database name in the output.
SELECT ''
EXCEPT
SELECT set_config('pg_no_seqscan.check_databases', current_database(), false);
 ?column? 
----------
 
(1 row)

-- Blocks query execution as check_databases is not set to the current database
SELECT * FROM test_db; -- Should error
ERROR:  A 'Sequential Scan' has been detected:

  - Tables involved:

  test_db

  - Query:

  SELECT * FROM test_db;

  - Query plan:

  Seq Scan on test_db


Make sure the query is compatible with the existing indexes.

-- Cleanup
DROP TABLE test_db;
RESET pg_no_seqscan.check_databases;
