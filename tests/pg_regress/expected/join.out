-- Test detection in JOIN
select Substr(setting, 1, 2) = '18' from pg_settings where name = 'server_version_num'; -- output changed slightly from PG18
 ?column? 
----------
 f
(1 row)

-- Setup
LOAD 'pg_no_seqscan';
SET pg_no_seqscan.level = ERROR;
SET enable_seqscan = off;
CREATE TABLE complex_query_foo AS (SELECT * FROM generate_series(1,10) as id);
CREATE TABLE complex_query_bar AS (SELECT * FROM generate_series(1,10) as id);
-- Blocks query execution as seqscan is done on both tables
EXPLAIN (COSTS OFF)
SELECT * FROM complex_query_foo JOIN complex_query_bar ON complex_query_foo.id = complex_query_bar.id;
                         QUERY PLAN                          
-------------------------------------------------------------
 Merge Join
   Merge Cond: (complex_query_foo.id = complex_query_bar.id)
   ->  Sort
         Sort Key: complex_query_foo.id
         ->  Seq Scan on complex_query_foo
   ->  Sort
         Sort Key: complex_query_bar.id
         ->  Seq Scan on complex_query_bar
(8 rows)

SELECT * FROM complex_query_foo JOIN complex_query_bar ON complex_query_foo.id = complex_query_bar.id;
ERROR:  A 'Sequential Scan' has been detected. Make sure the query is compatible with the existing indexes.
  - Tables involved: complex_query_bar
complex_query_foo
  - Query: SELECT * FROM complex_query_foo JOIN complex_query_bar ON complex_query_foo.id = complex_query_bar.id;
  - Query plan:

  Merge Join
  Merge Cond: (complex_query_foo.id = complex_query_bar.id)
  ->  Sort
        Sort Key: complex_query_foo.id
        ->  Seq Scan on complex_query_foo
  ->  Sort
        Sort Key: complex_query_bar.id
        ->  Seq Scan on complex_query_bar


create index foo_idx on complex_query_foo(id);
-- Blocks query execution as seqscan is done on bar in one part of the join
EXPLAIN (COSTS OFF)
SELECT * FROM complex_query_foo JOIN complex_query_bar ON complex_query_foo.id = complex_query_bar.id;
                           QUERY PLAN                           
----------------------------------------------------------------
 Hash Join
   Hash Cond: (complex_query_bar.id = complex_query_foo.id)
   ->  Seq Scan on complex_query_bar
   ->  Hash
         ->  Index Only Scan using foo_idx on complex_query_foo
(5 rows)

SELECT * FROM complex_query_foo JOIN complex_query_bar ON complex_query_foo.id = complex_query_bar.id;
ERROR:  A 'Sequential Scan' has been detected. Make sure the query is compatible with the existing indexes.
  - Tables involved: complex_query_bar
  - Query: SELECT * FROM complex_query_foo JOIN complex_query_bar ON complex_query_foo.id = complex_query_bar.id;
  - Query plan:

  Hash Join
  Hash Cond: (complex_query_bar.id = complex_query_foo.id)
  ->  Seq Scan on complex_query_bar
  ->  Hash
        ->  Index Only Scan using foo_idx on complex_query_foo


-- Cleanup
DROP TABLE complex_query_foo, complex_query_bar;
