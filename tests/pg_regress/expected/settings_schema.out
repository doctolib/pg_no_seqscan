-- Test schema filtering
-- Setup
LOAD 'pg_no_seqscan';
SET pg_no_seqscan.level = ERROR;
CREATE SCHEMA test_schema1;
CREATE SCHEMA test_schema2;
CREATE TABLE test_schema1.foo AS (SELECT * FROM generate_series(1,10) as id);
CREATE TABLE test_schema2.bar AS (SELECT * FROM generate_series(1,10) as id);
CREATE TABLE public.baz AS (SELECT * FROM generate_series(1,10) as id);
-- Set check_schemas to only check test_schema1 and public
SET pg_no_seqscan.check_schemas = 'test_schema1,public';
-- Allows query execution as test_schema2 is not in check_schemas setting
EXPLAIN (COSTS OFF) SELECT * FROM test_schema2.bar;
   QUERY PLAN    
-----------------
 Seq Scan on bar
(1 row)

SELECT * FROM test_schema2.bar;
 id 
----
  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
(10 rows)

-- Blocks query execution as test_schema1 is not in check_schemas setting
EXPLAIN (COSTS OFF) SELECT * FROM test_schema1.foo;
   QUERY PLAN    
-----------------
 Seq Scan on foo
(1 row)

SELECT * FROM test_schema1.foo;
ERROR:  A 'Sequential Scan' has been detected:

  - Tables involved:

  foo

  - Query:

  SELECT * FROM test_schema1.foo;

  - Query plan:

  Seq Scan on foo


Make sure the query is compatible with the existing indexes.

-- Cleanup
DROP TABLE test_schema1.foo, test_schema2.bar, public.baz;
DROP SCHEMA test_schema1, test_schema2;
RESET pg_no_seqscan.check_schemas;
