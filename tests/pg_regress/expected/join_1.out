-- Test detection in JOIN
SELECT 'Before PG 18?', setting::int / 10000 < 18 from pg_settings where name = 'server_version_num' ; -- output changed slightly from PG18
   ?column?    | ?column? 
---------------+----------
 Before PG 18? | f
(1 row)

-- Setup
LOAD 'pg_no_seqscan';
SET pg_no_seqscan.level = ERROR;
SET enable_seqscan = off;
CREATE TABLE complex_query_foo AS (SELECT * FROM generate_series(1,10) as id);
CREATE TABLE complex_query_bar AS (SELECT * FROM generate_series(1,10) as id);
-- Blocks query execution as seqscan is done on both tables
EXPLAIN (COSTS OFF)
SELECT * FROM complex_query_foo JOIN complex_query_bar ON complex_query_foo.id = complex_query_bar.id;
                         QUERY PLAN                          
-------------------------------------------------------------
 Merge Join
   Merge Cond: (complex_query_foo.id = complex_query_bar.id)
   ->  Sort
         Sort Key: complex_query_foo.id
         ->  Seq Scan on complex_query_foo
               Disabled: true
   ->  Sort
         Sort Key: complex_query_bar.id
         ->  Seq Scan on complex_query_bar
               Disabled: true
(10 rows)

SELECT * FROM complex_query_foo JOIN complex_query_bar ON complex_query_foo.id = complex_query_bar.id;
ERROR:  A 'Sequential Scan' has been detected. Make sure the query is compatible with the existing indexes.
  - Tables involved: complex_query_bar
complex_query_foo
  - Query: SELECT * FROM complex_query_foo JOIN complex_query_bar ON complex_query_foo.id = complex_query_bar.id;
  - Query plan:

  Merge Join
  Merge Cond: (complex_query_foo.id = complex_query_bar.id)
  ->  Sort
        Sort Key: complex_query_foo.id
        ->  Seq Scan on complex_query_foo
              Disabled: true
  ->  Sort
        Sort Key: complex_query_bar.id
        ->  Seq Scan on complex_query_bar
              Disabled: true


create index foo_idx on complex_query_foo(id);
-- Blocks query execution as seqscan is done on bar in one part of the join
EXPLAIN (COSTS OFF)
SELECT * FROM complex_query_foo JOIN complex_query_bar ON complex_query_foo.id = complex_query_bar.id;
                           QUERY PLAN                           
----------------------------------------------------------------
 Hash Join
   Hash Cond: (complex_query_bar.id = complex_query_foo.id)
   ->  Seq Scan on complex_query_bar
         Disabled: true
   ->  Hash
         ->  Index Only Scan using foo_idx on complex_query_foo
(6 rows)

SELECT * FROM complex_query_foo JOIN complex_query_bar ON complex_query_foo.id = complex_query_bar.id;
ERROR:  A 'Sequential Scan' has been detected. Make sure the query is compatible with the existing indexes.
  - Tables involved: complex_query_bar
  - Query: SELECT * FROM complex_query_foo JOIN complex_query_bar ON complex_query_foo.id = complex_query_bar.id;
  - Query plan:

  Hash Join
  Hash Cond: (complex_query_bar.id = complex_query_foo.id)
  ->  Seq Scan on complex_query_bar
        Disabled: true
  ->  Hash
        ->  Index Only Scan using foo_idx on complex_query_foo


-- Cleanup
DROP TABLE complex_query_foo, complex_query_bar;
