-- Test basic seqscan detection at different levels
-- Setup
LOAD 'pg_no_seqscan';
SET pg_no_seqscan.level = ERROR;
SET client_min_messages = NOTICE;
CREATE TABLE basic_seqscan AS (SELECT * FROM generate_series(1,10) AS id);
EXPLAIN (COSTS OFF) SELECT * FROM basic_seqscan;
        QUERY PLAN         
---------------------------
 Seq Scan on basic_seqscan
(1 row)

-- Allows query execution without warning as level is OFF
SET pg_no_seqscan.level = OFF;
SELECT * FROM basic_seqscan;
 id 
----
  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
(10 rows)

-- Allows query execution and print a warning as level is WARN
SET pg_no_seqscan.level = WARN;
SELECT * FROM basic_seqscan;
NOTICE:  A 'Sequential Scan' has been detected. Make sure the query is compatible with the existing indexes.
  - Tables involved: basic_seqscan
  - Query: SELECT * FROM basic_seqscan;
  - Query plan:

  Seq Scan on basic_seqscan


 id 
----
  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
(10 rows)

-- Blocks query execution as level is ERROR
SET pg_no_seqscan.level = ERROR;
SELECT * FROM basic_seqscan; -- This should fail
ERROR:  A 'Sequential Scan' has been detected. Make sure the query is compatible with the existing indexes.
  - Tables involved: basic_seqscan
  - Query: SELECT * FROM basic_seqscan;
  - Query plan:

  Seq Scan on basic_seqscan


-- Cleanup
DROP TABLE basic_seqscan;
RESET client_min_messages;
SET pg_no_seqscan.level = ERROR;
