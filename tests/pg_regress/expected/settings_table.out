-- Test table filtering with ignore_tables and check_tables
-- Setup
LOAD 'pg_no_seqscan';
SET pg_no_seqscan.level = ERROR;
CREATE TABLE foo (id serial);
CREATE TABLE bar (id serial);
EXPLAIN (COSTS OFF) SELECT * FROM foo;
   QUERY PLAN    
-----------------
 Seq Scan on foo
(1 row)

EXPLAIN (COSTS OFF) SELECT * FROM bar;
   QUERY PLAN    
-----------------
 Seq Scan on bar
(1 row)

SET pg_no_seqscan.ignore_tables = 'something,foo';
-- Allows query execution as foo is in ignore_tables setting
SELECT * FROM foo;
 id 
----
(0 rows)

-- Blocks query execution as bar is not in ignore_tables setting
SELECT * FROM bar;
ERROR:  A 'Sequential Scan' has been detected:

  - Tables involved:

  bar

  - Query:

  SELECT * FROM bar;

  - Query plan:

  Seq Scan on bar


Make sure the query is compatible with the existing indexes.

-- Testing now check_tables
RESET pg_no_seqscan.ignore_tables;
SET pg_no_seqscan.check_tables = 'something,foo';
-- Blocks query execution as foo is in check_tables setting
SELECT * FROM foo;
ERROR:  A 'Sequential Scan' has been detected:

  - Tables involved:

  foo

  - Query:

  SELECT * FROM foo;

  - Query plan:

  Seq Scan on foo


Make sure the query is compatible with the existing indexes.

-- Allows query execution as bar is not in check_tables setting
SELECT * FROM bar;
 id 
----
(0 rows)

-- Cleanup
DROP TABLE foo, bar;
RESET pg_no_seqscan.check_tables;
