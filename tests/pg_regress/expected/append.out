-- Test detection in APPEND
-- Setup
LOAD 'pg_no_seqscan';
SET pg_no_seqscan.level = ERROR;
SET enable_seqscan = off;
CREATE TABLE test_for_append (id int, data text);
INSERT INTO test_for_append SELECT i, 'data' || i FROM generate_series(1, 5) i;
-- Blocks query execution as both parts are seq scans
EXPLAIN (COSTS OFF) (SELECT * FROM test_for_append ORDER BY id LIMIT 1) UNION ALL (SELECT * FROM test_for_append ORDER BY id desc LIMIT 1);
                           QUERY PLAN                            
-----------------------------------------------------------------
 Append
   ->  Limit
         ->  Sort
               Sort Key: test_for_append.id
               ->  Seq Scan on test_for_append
   ->  Limit
         ->  Sort
               Sort Key: test_for_append_1.id DESC
               ->  Seq Scan on test_for_append test_for_append_1
(9 rows)

(SELECT * FROM test_for_append ORDER BY id LIMIT 1) UNION ALL (SELECT * FROM test_for_append ORDER BY id desc LIMIT 1);
ERROR:  A 'Sequential Scan' on test_for_append,test_for_append has been detected.
  - Run an EXPLAIN on your query to check the query plan.
  - Make sure the query is compatible with the existing indexes.

Query: (SELECT * FROM test_for_append ORDER BY id LIMIT 1) UNION ALL (SELECT * FROM test_for_append ORDER BY id desc LIMIT 1);

-- Blocks query execution as one part of the append is a seq scan.
CREATE INDEX test_for_append_idx ON test_for_append (id);
EXPLAIN (COSTS OFF) (SELECT * FROM test_for_append ORDER BY id LIMIT 1) UNION ALL (SELECT * FROM test_for_append ORDER BY random() LIMIT 1);
                              QUERY PLAN                               
-----------------------------------------------------------------------
 Append
   ->  Limit
         ->  Index Scan using test_for_append_idx on test_for_append
   ->  Subquery Scan on "*SELECT* 2"
         ->  Limit
               ->  Sort
                     Sort Key: (random())
                     ->  Seq Scan on test_for_append test_for_append_1
(8 rows)

(SELECT * FROM test_for_append ORDER BY id LIMIT 1) UNION ALL (SELECT * FROM test_for_append ORDER BY random() LIMIT 1);
ERROR:  A 'Sequential Scan' on test_for_append has been detected.
  - Run an EXPLAIN on your query to check the query plan.
  - Make sure the query is compatible with the existing indexes.

Query: (SELECT * FROM test_for_append ORDER BY id LIMIT 1) UNION ALL (SELECT * FROM test_for_append ORDER BY random() LIMIT 1);

-- Allows query execution as both parts are index scans
EXPLAIN (COSTS OFF) (SELECT * FROM test_for_append ORDER BY id LIMIT 1) UNION ALL (SELECT * FROM test_for_append ORDER BY id LIMIT 1 OFFSET 2);
                                      QUERY PLAN                                       
---------------------------------------------------------------------------------------
 Append
   ->  Limit
         ->  Index Scan using test_for_append_idx on test_for_append
   ->  Limit
         ->  Index Scan using test_for_append_idx on test_for_append test_for_append_1
(5 rows)

(SELECT * FROM test_for_append ORDER BY id LIMIT 1) UNION ALL (SELECT * FROM test_for_append ORDER BY id LIMIT 1 OFFSET 2);
 id | data  
----+-------
  1 | data1
  3 | data3
(2 rows)

DROP TABLE test_for_append;
